# Poker Helper Security Monitoring System

This directory contains the configuration for the security monitoring and alerting system for the Poker Helper project, based on Prometheus, Grafana (planned), and Alertmanager (planned).

## Overview

The system is designed to:
- Collect security-related metrics from various sources.
- Provide a dashboard for real-time visibility (via Grafana - to be set up).
- Trigger automated alerts for critical security events (via Alertmanager - to be set up).

## Components

1.  **Metric Collection Scripts (`./scripts/`)**
    *   `collect-npm-audit-metrics.js`: Runs `npm audit` and formats the vulnerability counts into Prometheus metrics format. Output: `metrics/npm_audit.prom`.
    *   `collect-github-actions-metrics.js`: Fetches run status and duration for the specified GitHub Actions security workflow. Output: `metrics/github_actions.prom`.
    *   `collect-jest-test-metrics.js`: Parses Jest JSON output to extract test pass/fail/skip counts and durations. Output: `metrics/jest_tests.prom`.
    *   `collect-pre-commit-metrics.js`: Parses logs (placeholder `pre-commit-times.log`) to extract performance of pre-commit hooks. Output: `metrics/pre_commit_hooks.prom`.

2.  **Prometheus (`./prometheus.yml`)**
    *   Configured to scrape metrics exposed by the collection scripts (via a simple HTTP server).
    *   Uses `file_sd_configs` to discover metric endpoints defined in `./metrics_targets/`.

3.  **Metrics Files (`./metrics/`)**
    *   This directory is where the `.prom` files generated by the scripts will be stored.
    *   It's served by the `metrics_file_server` defined in `docker-compose.yml`.

4.  **Prometheus Target Definitions (`./metrics_targets/`)**
    *   `npm_audit_targets.json`: Defines the target for npm audit metrics.
    *   `github_actions_targets.json`: Defines the target for GitHub Actions metrics.
    *   `jest_tests_targets.json`: Defines the target for Jest test metrics.
    *   `pre_commit_hooks_targets.json`: Defines the target for pre-commit hook metrics.

5.  **Docker Compose (`./docker-compose.yml`)**
    *   Sets up Prometheus.
    *   Sets up a simple Node.js `http-server` to serve the `.prom` files from the `./metrics` directory.
    *   Includes commented-out placeholders for Grafana and Alertmanager services.

6.  **Alertmanager (`./alertmanager.yml`)**
    *   Basic configuration for Alertmanager. Alerting rules and specific receiver integrations (e.g., Slack, email) need to be configured based on requirements.

## Setup and Usage

1.  **Prerequisites**:
    *   Docker and Docker Compose installed.
    *   Node.js and npm installed (for running collection scripts locally or if not using Docker for them).
    *   `GITHUB_TOKEN` environment variable set with a token that has permissions to read repository actions for `collect-github-actions-metrics.js`.
    *   `REPO_OWNER` and `REPO_NAME` environment variables set for `collect-github-actions-metrics.js` (or modify the script defaults).
    *   `WORKFLOW_ID` environment variable set to your security workflow file name (e.g., `security-scan.yml`) for `collect-github-actions-metrics.js`.
    *   Jest configured to output JSON results to `jest-results.json` (or update `JEST_RESULTS_FILE` in `collect-jest-test-metrics.js`).
    *   Pre-commit hooks configured to log performance to `pre-commit-times.log` (or update `PRE_COMMIT_LOG_FILE` in `collect-pre-commit-metrics.js` and its parsing logic).

2.  **Run Collection Scripts**:
    *   These scripts need to be run periodically (e.g., via cron jobs or within a CI/CD pipeline step after relevant actions occur) to update the `.prom` files in `./metrics/`.
    *   Example commands:
        ```bash
        node ./monitoring/scripts/collect-npm-audit-metrics.js
        # Ensure GITHUB_TOKEN, REPO_OWNER, REPO_NAME, WORKFLOW_ID are set for the next script
        node ./monitoring/scripts/collect-github-actions-metrics.js
        # Ensure jest-results.json exists
        node ./monitoring/scripts/collect-jest-test-metrics.js
        # Ensure pre-commit-times.log exists and has relevant data
        node ./monitoring/scripts/collect-pre-commit-metrics.js
        ```

3.  **Start Monitoring Stack**:
    *   Navigate to the `monitoring` directory.
    *   Run: `docker-compose up -d`

4.  **Access Prometheus**:
    *   Open your browser and go to `http://localhost:9090`.
    *   You should be able to query the collected metrics (e.g., `npm_vulnerabilities`, `github_workflow_run_status`, `jest_tests_total`).

## Next Steps

*   **Grafana Setup**: Uncomment and configure the Grafana service in `docker-compose.yml`. Create dashboards in Grafana to visualize the security metrics.
*   **Alertmanager Setup**: Uncomment and configure the Alertmanager service in `docker-compose.yml`. Define alerting rules in Prometheus (e.g., in a separate `rules.yml` file referenced by `prometheus.yml`) and configure receivers in `alertmanager.yml`.
*   **Automate Script Execution**: Set up cron jobs or integrate script execution into your CI/CD pipeline (e.g., GitHub Actions) to regularly update the metrics files.
*   **Logging Integration**: Ensure application logs are being collected by an existing logging infrastructure (e.g., ELK stack, Splunk). Correlate security metrics with logs where possible.
*   **Performance Impact Monitoring**: Add metrics to the collection scripts or directly instrument the CI/CD pipeline to measure the execution time of security-related stages/jobs. Monitor these in Prometheus/Grafana.
*   **Incident Response Automation**: Based on alerts from Alertmanager, define automated workflows (e.g., using webhooks to trigger scripts or CI/CD jobs for initial containment or information gathering).

## Security Considerations for Monitoring System

*   Ensure `GITHUB_TOKEN` has the minimum necessary permissions.
*   Protect access to Prometheus, Grafana, and Alertmanager instances.
*   Be mindful of any sensitive data that might inadvertently be exposed in metrics or logs.
